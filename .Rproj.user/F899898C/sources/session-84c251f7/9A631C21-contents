#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    https://shiny.posit.co/
#

library(shiny)

# Define UI for application
ui <- fluidPage(
  
  #Application title
  titlePanel("Cost-effectiveness analysis"),
  
  fluidRow(
    column(12,
           tabsetPanel(id = "tabset",
                       tabPanel("Import model (pdf file)", 
                                fileInput("modelstructure", "Model structure (pdf)", accept = "application/pdf")),
                       
                       tabPanel("Import data", 
                                fileInput("transitionrates", "Transition rates", accept = ".xlsx",buttonLabel = "Upload..."),
                                fileInput("hazardratios", "Hazard ratios for death", accept = ".xlsx", buttonLabel = "Upload..."),
                                fileInput("hazardratios_treat", "Hazard ratios for treatment", accept = ".xlsx", buttonLabel = "Upload..."),
                                fileInput("backmortality", "Background mortality probabilities", accept = ".xlsx", buttonLabel = "Upload..."),
                                fileInput("costs", "Healthcare costs", accept = ".xlsx", buttonLabel = "Upload..."),
                                fileInput("costs_treat", "Healthcare costs for treatment", accept = ".xlsx", buttonLabel = "Upload..."),
                                fileInput("utilities", "Utilities", accept = ".xlsx", buttonLabel = "Upload..."),
                                fileInput("utility_multiplier", "Utility multiplier for age", accept = ".xlsx", buttonLabel = "Upload...")
                       ),
                       
                       tabPanel("Cycle length and number of cycles",
                                selectInput("cyclelength", "Cycle length of the model:", c("annual", "monthly")),
                                sliderInput("n_cycles", "Number of cycles", value = 10, min = 1, max = 35)
                       ),
                       
                       tabPanel("Annual discounting rate",
                                sliderInput("r_annual_discount", "Annual discounting (%)", value = 3, min = 0, max = 5)
                       )
           )  
    )
  ),
  
  fluidRow(
    column(12,
           tableOutput("cyclenum")
    )
  )
)


#Function for input of model structure
load_modelstructure <- function(name, path) {
  ext <- tools::file_ext(name)
  switch(ext,
         pdf = pdf_text(path),
         validate("Invalid file. Please upload a .pdf file for the model structure")
  )
}

#Function for input of excel files (model input parameters)
load_file <- function(name, path) {
  ext <- tools::file_ext(name)
  switch(ext,
         xlsx = read_excel(path), 
         validate("Invalid file. Please upload a .xlsx file")
  )
}


#Server for the application
server <- function(input, output, session) {
  
  observeEvent(input$cyclelength, {
    if (input$cyclelength == "annual") {
      range <- c(1, 35)
    }
    else if (input$cyclelength == "monthly") {
      range <- c(12, 420)
    }
    updateSliderInput(session, "n_cycles", 
                      value = range,
                      min = min(range),
                      max = max(range),
                      step = 1)
  })
  
  output$cyclenum <- renderText({
    paste0("number of cycles is ", input$n_cycles)
  })
  
}

# Run the application 
shinyApp(ui = ui, server = server)
